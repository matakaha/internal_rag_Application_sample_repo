name: Deploy to Azure Functions

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: 'aci-runner-deployment'
  cancel-in-progress: false

env:
  RESOURCE_GROUP: 'rg-internal-rag-dev'
  FUNCTIONAPP_NAME: 'func-internal-rag-dev'
  CONTAINER_GROUP_NAME: 'aci-github-runner-dev'
  VNET_NAME: 'vnet-internal-rag-dev'
  SUBNET_NAME: 'snet-container-instances'
  LOCATION: 'japaneast'
  PYTHON_VERSION: '3.11'
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  setup-runner:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      runner-name: ${{ steps.restart-runner.outputs.runner-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Restart Container Instance Runner
        id: restart-runner
        run: |
          # Runner名を生成
          RUNNER_NAME="runner-${{ github.run_id }}"
          echo "runner-name=$RUNNER_NAME" >> $GITHUB_OUTPUT

          # GitHub Runner登録トークン取得
          RUNNER_TOKEN=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token" \
            | jq -r .token)

          echo "RUNNER_TOKEN取得完了"

          # 既存のContainer Instanceの存在確認
          echo "Checking for existing container instance..."
          EXISTING=$(az container list \
            --resource-group $RESOURCE_GROUP \
            --query "[?name=='$CONTAINER_GROUP_NAME'].name" -o tsv)
          
          if [ -n "$EXISTING" ]; then
            echo "Existing container found. Stopping and deleting..."
            
            # 既存のContainer Instanceを停止
            az container stop \
              --resource-group $RESOURCE_GROUP \
              --name $CONTAINER_GROUP_NAME || true
            
            echo "Waiting for container to stop..."
            sleep 5
            
            # Container Instance削除
            az container delete \
              --resource-group $RESOURCE_GROUP \
              --name $CONTAINER_GROUP_NAME \
              --yes
            
            echo "Waiting for deletion to complete..."
            sleep 5
          else
            echo "No existing container found. Will create new one."
          fi

          # ACRのリソースIDを取得
          ACR_ID=$(az acr show --name acrinternalragdev --resource-group $RESOURCE_GROUP --query id -o tsv)
          
          # まず最小構成でContainer Instance作成(System Assigned Managed Identity付き)
          # 注: この時点ではACRイメージは使わず、パブリックイメージで起動
          echo "Creating container with Managed Identity (initial)..."
          az container create \
            --resource-group $RESOURCE_GROUP \
            --name $CONTAINER_GROUP_NAME \
            --image mcr.microsoft.com/azuredocs/aci-helloworld \
            --assign-identity \
            --os-type Linux \
            --vnet $VNET_NAME \
            --subnet $SUBNET_NAME \
            --location $LOCATION \
            --cpu 1 \
            --memory 1 \
            --restart-policy Never
          
          # Managed IdentityのPrincipal IDを取得
          PRINCIPAL_ID=$(az container show \
            --resource-group $RESOURCE_GROUP \
            --name $CONTAINER_GROUP_NAME \
            --query identity.principalId -o tsv)
          
          echo "Managed Identity Principal ID: $PRINCIPAL_ID"
          
          # Managed IdentityにACR Pull権限を付与
          echo "Assigning AcrPull role to Managed Identity..."
          az role assignment create \
            --assignee $PRINCIPAL_ID \
            --role AcrPull \
            --scope $ACR_ID
          
          # 権限の伝播を待つ
          echo "Waiting for role assignment to propagate..."
          sleep 30
          
          # コンテナを削除
          echo "Deleting temporary container..."
          az container delete \
            --resource-group $RESOURCE_GROUP \
            --name $CONTAINER_GROUP_NAME \
            --yes
          
          sleep 5
          
          # 今度は同じManaged Identity(Principal ID)を使って再作成
          # Private Endpoint経由でACRにアクセス(vNet内部通信)
          echo "Creating GitHub Runner container with ACR image..."
          
          # User Assigned Managed Identityを作成
          IDENTITY_NAME="id-aci-runner-${GITHUB_RUN_ID}"
          az identity create \
            --name $IDENTITY_NAME \
            --resource-group $RESOURCE_GROUP \
            --location $LOCATION
          
          # IdentityのIDを取得
          IDENTITY_ID=$(az identity show \
            --name $IDENTITY_NAME \
            --resource-group $RESOURCE_GROUP \
            --query id -o tsv)
          
          IDENTITY_PRINCIPAL_ID=$(az identity show \
            --name $IDENTITY_NAME \
            --resource-group $RESOURCE_GROUP \
            --query principalId -o tsv)
          
          # IdentityにACR Pull権限を付与
          echo "Assigning AcrPull role to User Assigned Identity..."
          az role assignment create \
            --assignee $IDENTITY_PRINCIPAL_ID \
            --role AcrPull \
            --scope $ACR_ID
          
          sleep 20
          
          # User Assigned Managed Identityを使ってコンテナ作成
          az container create \
            --resource-group $RESOURCE_GROUP \
            --name $CONTAINER_GROUP_NAME \
            --image acrinternalragdev.azurecr.io/github-runner:latest \
            --assign-identity $IDENTITY_ID \
            --acr-identity $IDENTITY_ID \
            --os-type Linux \
            --vnet $VNET_NAME \
            --subnet $SUBNET_NAME \
            --location $LOCATION \
            --cpu 2 \
            --memory 4 \
            --restart-policy Never \
            --environment-variables \
              RUNNER_NAME=$RUNNER_NAME \
              RUNNER_TOKEN=$RUNNER_TOKEN \
              GITHUB_TOKEN=${{ secrets.GH_PAT }} \
              RUNNER_REPOSITORY_URL=https://github.com/${{ github.repository }} \
              RUNNER_LABELS=self-hosted,azure,vnet
          
          # ACIが起動するまで少し待機
          sleep 15

          # Runnerが登録されるまで待機
          echo "Waiting for runner to register with GitHub..."
          MAX_WAIT=300
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RUNNER_STATUS=$(curl -s \
              -H "Authorization: token ${{ secrets.GH_PAT }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners" \
              | jq -r ".runners[] | select(.name==\"$RUNNER_NAME\") | .status")
            
            if [ "$RUNNER_STATUS" = "online" ]; then
              echo "Runner is online and ready!"
              break
            fi
            
            echo "Runner status: ${RUNNER_STATUS:-not found}. Waiting... ($ELAPSED/$MAX_WAIT seconds)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Error: Runner did not come online within $MAX_WAIT seconds"
            exit 1
          fi

  build-and-deploy:
    needs: setup-runner
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.FUNCTIONAPP_NAME }}
          package: '.'
          scm-do-build-during-deployment: true
          enable-oryx-build: true

  cleanup:
    needs: [setup-runner, build-and-deploy]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Remove GitHub Runner
        run: |
          RUNNER_NAME="${{ needs.setup-runner.outputs.runner-name }}"
          
          # Runner IDを取得
          RUNNER_ID=$(curl -s \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners" \
            | jq -r ".runners[] | select(.name==\"$RUNNER_NAME\") | .id")
          
          if [ -n "$RUNNER_ID" ]; then
            echo "Removing runner ID: $RUNNER_ID"
            curl -s -X DELETE \
              -H "Authorization: token ${{ secrets.GH_PAT }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners/$RUNNER_ID"
            echo "Runner removed from GitHub"
          else
            echo "Runner not found in GitHub"
          fi

      - name: Stop Container Instance
        run: |
          echo "Stopping container instance (not deleting to avoid charges)..."
          az container stop \
            --resource-group $RESOURCE_GROUP \
            --name $CONTAINER_GROUP_NAME || true
          
          echo "Container instance stopped (will remain in failed/stopped state)"
